(()=>{"use strict";const e=e=>Math.floor(Math.random()*e)+1,t=()=>e(1e8);new Map;class n{constructor(e,t){this.x=e,this.y=t}}class o{constructor(e,t,n){this.x=e,this.y=t,this.z=n}}var s;!function(e){e[e.Health=0]="Health",e[e.Camera=1]="Camera",e[e.Light=2]="Light",e[e.Rotation=3]="Rotation",e[e.EntityState=4]="EntityState",e[e.Name=5]="Name",e[e.EntityType=6]="EntityType",e[e.Position=7]="Position",e[e.TargetLocation=8]="TargetLocation",e[e.Timer=9]="Timer",e[e.BoxShape=10]="BoxShape",e[e.Mass=11]="Mass",e[e.ShapeColor=12]="ShapeColor",e[e.Force=13]="Force",e[e.HardCodedId=14]="HardCodedId"}(s||(s={}));const i=(()=>{let e=0;for(let t=0;t<Object.keys(s).length/2;t++)e++;return e})();var a,d,c,m,r,h,p,l,u;!function(e){e[e.Animation=0]="Animation"}(a||(a={})),function(e){e[e.Stickman=0]="Stickman",e[e.Grass=1]="Grass",e[e.Dog=2]="Dog",e[e.Camera=3]="Camera",e[e.Light=4]="Light",e[e.GeometricShape=5]="GeometricShape"}(d||(d={})),function(e){e[e.Idle=0]="Idle",e[e.Run=1]="Run",e[e.Follow=2]="Follow",e[e.Attack=3]="Attack",e[e.Chase=4]="Chase"}(c||(c={})),function(e){e[e.AmbientLight=0]="AmbientLight",e[e.PointLight=1]="PointLight",e[e.DirectionalLight=2]="DirectionalLight",e[e.SpotLight=3]="SpotLight"}(m||(m={})),function(e){e[e.Box=0]="Box"}(r||(r={}));class C{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.HardCodedId,this.id=e}}class y{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.ShapeColor,this.color=e}}class f{constructor(e,n,o){this.componentUid=t(),this.entityUid=o,this.componentType=s.BoxShape,this.size=e,this.shapeType=n}}class g{constructor(e,n,o,i,a,d){this.componentUid=t(),this.entityUid=d,this.componentType=s.Light,this.lightType=e,this.intensity=n,this.color=o,this.distance=i,this.decay=a}}class w{constructor(e,n,o,i,a){this.componentUid=t(),this.entityUid=a,this.componentType=s.Camera,this.fov=e,this.near=n,this.far=o,this.aspect=i}}class x{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.EntityType,this.entityType=e}}class T{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.EntityState,this.states=e}}class S{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.Position,this.x=e.x,this.y=e.y,this.z=e.z}}class v{constructor(e,n){this.componentUid=t(),this.entityUid=n,this.componentType=s.Health,this.health=e}}class E{constructor(e,n){this.x=e.x,this.y=e.y,this.z=e.z,this.componentUid=t(),this.entityUid=n,this.componentType=s.Force}}class U{constructor(e,n){this.mass=e,this.componentUid=t(),this.entityUid=n,this.componentType=s.Mass}}class z{constructor(e,n){this.x=e.x,this.y=e.y,this.z=e.z,this.componentUid=t(),this.entityUid=n,this.componentType=s.Rotation}}class B{constructor(){this.changedComponents=[],this.addedEntitiesUid=[],this.removedEntitiesUid=[]}}!function(e){e[e.Start=0]="Start",e[e.Input=1]="Input",e[e.Options=2]="Options",e[e.GraphicChanges=3]="GraphicChanges"}(h||(h={}));class A{constructor(e,t=null){this.message=e,this.data=t}}function b(e){switch(e){case p.TheFirst:return new I;case p.RunCode:return new G;case p.Collide:return new O;case p.ApplyForce:return new D;case p.MoveGeometry:return new M;case p.SendGraphicComponentsToRender:return new k;case p.CreateStickman:return new R;case p.MovePlayer:return new L;case p.CreateScene:return new F;case p.CreateGravity:return new P}}!function(e){e[e.TheFirst=0]="TheFirst",e[e.RunCode=1]="RunCode",e[e.CreateStickman=2]="CreateStickman",e[e.MovePlayer=3]="MovePlayer",e[e.MoveGeometry=4]="MoveGeometry",e[e.ApplyForce=5]="ApplyForce",e[e.CreateGravity=6]="CreateGravity",e[e.CreateScene=7]="CreateScene",e[e.Collide=8]="Collide",e[e.SendGraphicComponentsToRender=9]="SendGraphicComponentsToRender"}(p||(p={}));class I{constructor(){this.commandType=p.TheFirst}run(e,t){e.addCommand(p.CreateScene),e.addCommand(p.SendGraphicComponentsToRender),e.addCommand(p.ApplyForce),e.addCommand(p.RunCode),e.addCommand(p.Collide),e.removeCommand(p.TheFirst)}}class G{constructor(){this.commandType=p.RunCode}run(e,t){t.input.code}}class F{constructor(){this.commandType=p.CreateScene}run(n,s){{let e=t(),i=new w(45,.1,500,s.domState.windowWidth/s.domState.windowHeight,e),a=new S(new o(0,14,8),e),c=new z(new o(-60,0,0),e),m=new x(d.Camera,e);n.addComponent(i),n.addComponent(c),n.addComponent(a),n.addComponent(m)}{let e=t(),s=new g(m.PointLight,10,16777215,10,0,e),i=new S(new o(0,3,1),e),a=new x(d.Light,e);n.addComponent(s),n.addComponent(i),n.addComponent(a)}{let e=t(),o=new g(m.AmbientLight,.5,16777215,0,0,e),s=new x(d.Light,e);n.addComponent(o),n.addComponent(s)}{let e=t(),s=new f(new o(8,.2,8),r.Box,e),i=new S(new o(0,-1.1,0),e),a=new y(8978380,e),c=new x(d.GeometricShape,e);n.addComponent(s),n.addComponent(i),n.addComponent(a),n.addComponent(c)}{let e=t(),s=new f(new o(1,2,1),r.Box,e),i=new S(new o(0,0,0),e),a=new y(16733644,e),c=new x(d.GeometricShape,e),m=new E(new o(0,0,0),e),h=new U(3.5,e),l=new C(0,e);n.addComponent(s),n.addComponent(l),n.addComponent(h),n.addComponent(i),n.addComponent(m),n.addComponent(a),n.addComponent(c),n.addCommand(p.MoveGeometry)}for(let s=0;s<5;s++)for(let i=0;i<5;i++){if(2==e(20)){let e=t(),a=new f(new o(1,1,1),r.Box,e),c=new S(new o(-s,-.5,-i),e),m=new y(1122986,e),h=new x(d.GeometricShape,e),p=new E(new o(0,0,0),e),l=new U(3.5,e);n.addComponent(a),n.addComponent(l),n.addComponent(c),n.addComponent(p),n.addComponent(m),n.addComponent(h)}if(2==e(20)){let e=t(),a=new f(new o(1,1,1),r.Box,e),c=new S(new o(s+1,-.5,i+1),e),m=new y(1122986,e),h=new x(d.GeometricShape,e),p=new E(new o(0,0,0),e),l=new U(3.5,e);n.addComponent(a),n.addComponent(l),n.addComponent(c),n.addComponent(p),n.addComponent(m),n.addComponent(h)}}n.removeCommand(p.CreateScene)}}class M{constructor(){this.commandType=p.MoveGeometry}run(e,t){let n=.02,i=e.find([l.All,[s.HardCodedId],u.Any,null]);if(0==i[0].length)return void console.log("no hardcodedid found");let a=i[0][0].entityUid,d=e.find([l.One,[s.Force],u.EntityId,a]);if(0==d[0].length)return void console.log("no geometry force found");let c=d[0][0],m=new o(0,0,0);m.x=c.x+.003*t.input.movementDirection.x,m.z=c.z+.003*-t.input.movementDirection.y,Math.abs(m.x)>n&&(m.x=n*(m.x<0?-1:1)),Math.abs(m.z)>n&&(m.z=n*(m.z<0?-1:1)),0!=t.input.movementDirection.x&&(c.x=m.x),0!=t.input.movementDirection.y&&(c.z=m.z)}}class R{constructor(){this.commandType=p.CreateStickman}run(e,n){for(let n=0;n<1;n++)for(let n=0;n<1;n++){let n=t(),s=new S(new o(0,0,0),n),i=new T([c.Idle],n),a=new x(d.Stickman,n),m=new v(10,n),h=new E(new o(0,0,0),n),p=new U(4,n),l=new f(new o(40,90,30),r.Box,n);e.addComponent(p),e.addComponent(l),e.addComponent(h),e.addComponent(m),e.addComponent(s),e.addComponent(i),e.addComponent(a)}e.addCommand(p.MovePlayer),e.removeCommand(p.CreateStickman)}}class L{constructor(){this.commandType=p.MovePlayer}run(e,t){let n=.02,i=e.find([l.All,[s.EntityType],u.Any,null]);if(0==i[0].length)return void console.log("no entity types found");let a=null;for(let e of i[0]){let t=e;t.entityType==d.Stickman&&(a=t.entityUid)}if(null==a)return;if(0==t.input.movementDirection.x&&0==t.input.movementDirection.y){let t=e.find([l.All,[s.EntityState],u.EntityId,i[0][0].entityUid]);if(0==t[0].length)return void console.log("entityState not found");for(let e of t[0]){let t=e;if(t.entityUid==a){let e=t.states.indexOf(c.Run);if(-1!=e){if(t.states.splice(e,1),t.states.includes(c.Idle))return;t.states.push(c.Idle)}return}}}let m=e.find([l.One,[s.Force],u.EntityId,a]);if(0==m[0].length)return void console.log("no player force found found");let r=m[0][0],h=new o(0,0,0);h.x=r.x+.003*t.input.movementDirection.x,h.z=r.z+.003*-t.input.movementDirection.y,Math.abs(h.x)>n&&(h.x=n*(h.x<0?-1:1)),Math.abs(h.z)>n&&(h.z=n*(h.z<0?-1:1));let p=e.find([l.One,[s.EntityState],u.EntityId,a]);if(0==p[0].length)return void console.log("player entityState not found");let C=p[0][0];C.states.includes(c.Run)||C.states.push(c.Run);let y=C.states.indexOf(c.Idle);-1!=y&&C.states.splice(y,1),0!=t.input.movementDirection.x&&(r.x=h.x),0!=t.input.movementDirection.y&&(r.z=h.z)}}class k{constructor(){this.commandType=p.SendGraphicComponentsToRender}run(e,t){let n=new B;n.changedComponents.push(...t.componentChanges.changedComponents[s.Camera]),n.changedComponents.push(...t.componentChanges.changedComponents[s.Light]),n.changedComponents.push(...t.componentChanges.changedComponents[s.Position]),n.changedComponents.push(...t.componentChanges.changedComponents[s.EntityState]),n.changedComponents.push(...t.componentChanges.changedComponents[s.Rotation]),n.changedComponents.push(...t.componentChanges.changedComponents[s.BoxShape]),n.changedComponents.push(...t.componentChanges.changedComponents[s.ShapeColor]),n.changedComponents.push(...t.componentChanges.addedComponents[s.EntityType]),n.changedComponents.push(...t.componentChanges.addedComponents[s.Camera]),n.changedComponents.push(...t.componentChanges.addedComponents[s.Light]),n.changedComponents.push(...t.componentChanges.addedComponents[s.Position]),n.changedComponents.push(...t.componentChanges.addedComponents[s.EntityState]),n.changedComponents.push(...t.componentChanges.addedComponents[s.Rotation]),n.changedComponents.push(...t.componentChanges.addedComponents[s.BoxShape]),n.changedComponents.push(...t.componentChanges.addedComponents[s.ShapeColor]);for(let e of t.componentChanges.removedComponents[s.EntityType])n.removedEntitiesUid.push(e.entityUid);for(let e of t.componentChanges.addedComponents[s.EntityType])n.addedEntitiesUid.push(e.entityUid);0==n.changedComponents.length&&0==n.removedEntitiesUid.length||postMessage(new A(h.GraphicChanges,n))}}class P{constructor(){this.commandType=p.CreateGravity}run(e,t){let n=e.find([l.All,[s.Force],u.Any,null]);if(0!=n[0].length)for(let e of n[0]){let t=.003;e.y-=t}else console.log("no force components")}}class D{constructor(){this.commandType=p.ApplyForce}run(e,t){let n=t.delta.get();if(null==n)return;let i=e.find([l.All,[s.Force],u.Any,null]);if(0!=i[0].length)for(let t of i[0]){let i=t;if(0==i.x&&0==i.y&&0==i.z)continue;let a=e.find([l.One,[s.Position,s.Mass],u.EntityId,t.entityUid]);if(0==a[0].length||0==a[1].length)return void console.log("no position or mass component");let d=a[0][0],c=a[1][0],m=new o(0,0,0),r=.001,h=new o(0,0,0);i.x<0&&(h.x=i.x+r,h.x>0&&(h.x=0)),i.x>0&&(h.x=i.x-r,h.x<0&&(h.x=0)),i.y<0&&(h.y=i.y+r,h.y>0&&(h.y=0)),i.y>0&&(h.y=i.y-r,h.y<0&&(h.y=0)),i.z<0&&(h.z=i.z+r,h.z>0&&(h.z=0)),i.z>0&&(h.z=i.z-r,h.z<0&&(h.z=0)),m.x=i.x/c.mass,m.y=i.y/c.mass,m.z=i.z/c.mass,0!=m.x&&(d.x=d.x+m.x*n,i.x=h.x),0!=m.y&&(d.y=d.y+m.y*n,i.y=h.y),0!=m.z&&(d.z=d.z+m.z*n,i.z=h.z)}else console.log("no force components")}}class O{constructor(){this.commandType=p.Collide}run(e,t){}}!function(e){e[e.One=0]="One",e[e.All=1]="All"}(l||(l={})),function(e){e[e.EntityId=0]="EntityId",e[e.EntityType=1]="EntityType",e[e.ComponentId=2]="ComponentId",e[e.Any=3]="Any"}(u||(u={}));class H{constructor(){this.removedCommands=[],this.addedCommands=[]}clearChanges(){this.removedCommands=[],this.addedCommands=[]}}class W{constructor(e,t){this.time=e,this.command=t}}class N{constructor(e){this.currentExecutingCommand=e,this.lastTimeCommandsWereRun=[]}get(){for(let e of this.lastTimeCommandsWereRun)if(e.command==this.currentExecutingCommand.command){let t=e.time;return e.time=performance.now(),performance.now()-t}return this.lastTimeCommandsWereRun.push(new W(performance.now(),this.currentExecutingCommand.command)),null}}class j{constructor(e){this.currentExecutingCommand=e,this.state=new Map}removeCommandStates(e){for(let[t,n]of this.state)t[1]==e&&this.state.delete(t)}set(e,t){this.state.set([e,this.currentExecutingCommand.command],t)}get(e){console.log(this.state);let t=this.state.get([e,this.currentExecutingCommand.command]);return null==t?void 0:t[1]}}class q{constructor(e){this.currentExecutingCommand=e,this.commandsCheckedFirstTime=[]}get(){for(let e of this.commandsCheckedFirstTime)if(e==this.currentExecutingCommand.command)return!1;return this.commandsCheckedFirstTime.push(this.currentExecutingCommand.command),!0}}class ${constructor(){this.isSetNight=void 0,this.isShadowsEnabled=void 0,this.isEnablePhysics=void 0,this.isEnableFreeCamera=void 0}}class J{constructor(){this.windowWidth=void 0,this.windowHeight=void 0}}class K{constructor(){this.movementDirection=new n(0,0),this.code=void 0}}class Q{constructor(){this.baseStructure=[];for(let e=0;e<i;e++)this.baseStructure.push([]);this.changedComponentsBuffer=structuredClone(this.baseStructure),this.removedComponentsBuffer=structuredClone(this.baseStructure),this.addedComponentsBuffer=structuredClone(this.baseStructure),this.changedComponents=[],this.removedComponents=[],this.addedComponents=[]}cycleChanges(){this.changedComponents=this.changedComponentsBuffer,this.removedComponents=this.removedComponentsBuffer,this.addedComponents=this.addedComponentsBuffer,this.changedComponentsBuffer=structuredClone(this.baseStructure),this.removedComponentsBuffer=structuredClone(this.baseStructure),this.addedComponentsBuffer=structuredClone(this.baseStructure)}}class V{constructor(){}}let X=new class{constructor(){this.command=null}},Y=new class{constructor(e){this.domState=new J,this.delta=new N(e),this.isFirstTime=new q(e),this.commandState=new j(e),this.componentChanges=new Q,this.input=new K,this.options=new $,this.positionGrid=new V}}(X),Z=new class{constructor(e,t){this.accessedComponent=null,this.resources=e,this.currentExecutingCommand=t,this.commandChangesBuffer=new H,this.commands=[],this.components=[];for(let e=0;e<i;e++)this.components.push([])}removeCommand(e){this.commandChangesBuffer.removedCommands.push(e)}addCommand(e){this.commandChangesBuffer.addedCommands.push(e)}addComponent(e){this.components[e.componentType].push(this.createProxy(e)),this.resources.componentChanges.addedComponentsBuffer[e.componentType].push(e)}removeComponent(e){for(let[t,n]of this.components[e.componentType].entries())n.componentUid==e.componentUid&&(this.resources.componentChanges.removedComponentsBuffer[e.componentType].push(e),this.components.splice(t,1))}createProxy(e){let t=this,n={set(e,n,o){"componentUid"in e&&(t.accessedComponent=e);let s=!1;for(let e of t.resources.componentChanges.changedComponentsBuffer[t.accessedComponent.componentType])e.componentUid==t.accessedComponent.componentUid&&(s=!0);return s||t.resources.componentChanges.changedComponentsBuffer[t.accessedComponent.componentType].push(t.accessedComponent),e[n]=o,!0},get:(e,n)=>("componentUid"in e&&(t.accessedComponent=e),"object"==typeof e[n]?t.createProxy(e[n]):e[n])};return new Proxy(e,n)}find(e){if(0==e[1].length)return console.log("no components expecified"),[];if(e[2]==u.EntityType&&null==e[3]||e[2]==u.ComponentId&&"number"!=typeof e[3]||e[2]==u.EntityId&&"number"!=typeof e[3])return console.log('argument does not match "By" enum'),[];if(e[0]==l.All&&e[2]==u.ComponentId)return console.log("cannot get all by component id"),[];if(e[0]==l.One&&e[2]==u.EntityType)return console.log("query Get.One By.EntityType is not supported yet"),[];if(e[0]==l.One&&e[2]==u.Any)return console.log("query Get.One By.Any is not supported yet"),[];let t=[];for(let n=0;n<e[1].length;n++)t.push([]);for(let[n,o]of e[1].entries())if(e[0]==l.One){if(e[2]==u.ComponentId){for(let s of this.components[o])if(e[3]==s.componentUid){t[n].push(s);break}continue}if(e[2]==u.EntityId){for(let s of this.components[o])if(e[3]==s.entityUid){t[n].push(s);break}continue}}else if(e[0]==l.All){if(e[2]==u.EntityId){for(let s of this.components[o])e[3]==s.entityUid&&t[n].push(s);continue}if(e[2]==u.Any){for(let e of this.components[o])t[n].push(e);continue}}return t}updateCommands(){for(let e of this.commandChangesBuffer.addedCommands){let t=!1;for(let n of this.commands)e==n.commandType&&(console.log("$ command already exists"),t=!0);if(t)continue;let n=b(e),o=!1;for(let[t,s]of this.commands.entries())if(e<s.commandType){o=!0,this.commands.splice(t,0,n);break}o||this.commands.push(n)}for(let e of this.commandChangesBuffer.removedCommands){let t=!1;for(let n=this.commands.length-1;n>=0;n--)e==this.commands[n].commandType&&(t=!0,this.commands.splice(n,1),this.resources.commandState.removeCommandStates(e));t||console.log("$ command was not found")}}run(){for(let e of this.commands)this.currentExecutingCommand.command=e.commandType,e.run(this,this.resources);this.updateCommands(),this.commandChangesBuffer.clearChanges(),this.resources.componentChanges.cycleChanges()}}(Y,X);onmessage=e=>{let t=e.data;switch(t.message){case h.Start:{let e=t.data;Y.domState.windowHeight=e.windowHeight,Y.domState.windowWidth=e.windowWidth,Z.addCommand(p.TheFirst),setInterval(Z.run.bind(Z),1e3)}break;case h.Input:{let e=t.data;Y.input.movementDirection=e.movementDirection,Y.input.code=e.code}break;case h.Options:t.data}}})();